name: Release Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - windows
          - linux
          - macos
      config_url:
        description: 'Config URL'
        required: false
      config_key:
        description: 'Config Key'
        required: false
      config_sources_json:
        description: 'Config Sources (JSON list)'
        required: false
  push:
    tags:
      - "v*"

env:
  PRIVATE_REPO: git@github.com:KirCloud/KirClash.git
  SOURCE_DIR: source
  IS_STABLE: ${{ !contains(github.ref, '-') }}

jobs:
  build:
    name: Build ${{ matrix.platform }} ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    env:
      SHOULD_RUN: ${{ github.event_name == 'push' || github.event.inputs.platform == 'all' || github.event.inputs.platform == matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: android
            os: ubuntu-latest
          - platform: windows
            os: windows-latest
            arch: amd64
          - platform: linux
            os: ubuntu-22.04
            arch: amd64
          - platform: linux
            os: ubuntu-24.04-arm
            arch: arm64
          - platform: macos
            os: macos-15-intel
            arch: amd64
          - platform: macos
            os: macos-latest
            arch: arm64

    steps:
      # --- SSH Setup ---
      - name: Setup SSH
        if: env.SHOULD_RUN == 'true'
        shell: bash
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRIVATE_REPO_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      # --- Clone Source ---
      - name: Clone source
        if: env.SHOULD_RUN == 'true'
        shell: bash
        run: git clone --recursive $PRIVATE_REPO $SOURCE_DIR

      # --- Extract Version ---
      - name: Extract version
        if: env.SHOULD_RUN == 'true'
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # --- Android Signing (Only for Android) ---
      - name: Setup Android Signing
        if: env.SHOULD_RUN == 'true' && matrix.platform == 'android'
        run: |
          cd $SOURCE_DIR
          echo "${{ secrets.KEYSTORE }}" | base64 --decode > android/app/keystore.jks
          echo "${{ secrets.SERVICE_JSON }}" | base64 --decode > android/app/google-services.json
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/local.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/local.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/local.properties

      # --- Setup Go ---
      - uses: actions/setup-go@v5
        if: env.SHOULD_RUN == 'true'
        with:
          go-version: '1.24.0'
          cache-dependency-path: source/core/go.sum

      # --- Setup Flutter (Standard) ---
      - uses: subosito/flutter-action@v2
        if: env.SHOULD_RUN == 'true' && matrix.os != 'ubuntu-24.04-arm'
        with:
          channel: stable
          flutter-version: 3.35.7
          cache: true

      # --- Setup Flutter (Linux ARM64 / Master) ---
      - uses: subosito/flutter-action@v2
        if: env.SHOULD_RUN == 'true' && matrix.os == 'ubuntu-24.04-arm'
        with:
          channel: master
          flutter-version: 3.35.7
          cache: true

      # --- Build Dependencies & Application ---
      - name: Build Application
        if: env.SHOULD_RUN == 'true'
        shell: bash
        env:
          CONFIG_URL: ${{ github.event.inputs.config_url }}
          CONFIG_KEY: ${{ github.event.inputs.config_key }}
          CONFIG_SOURCES_JSON: ${{ github.event.inputs.config_sources_json }}
        run: |
          cd $SOURCE_DIR
          flutter pub get
          dart tool/embed_config.dart
          dart setup.dart ${{ matrix.platform }} ${{ matrix.arch && format('--arch {0}', matrix.arch) || '' }} ${{ env.IS_STABLE == 'true' && '--env stable' || '' }}

      # --- Post-Build (Copy Release Template) ---
      - name: Copy Release Template (Linux Only)
        if: env.SHOULD_RUN == 'true' && matrix.platform == 'linux' && matrix.arch == 'amd64'
        shell: bash
        run: |
          cp $SOURCE_DIR/.github/release_template.md $SOURCE_DIR/dist/ || true

      # --- Upload Artifacts ---
      - name: Upload Artifacts
        if: env.SHOULD_RUN == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: artifact-${{ matrix.platform }}-${{ matrix.arch || 'universal' }}
          path: source/dist/*
          overwrite: true

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions: write-all
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Prepare release notes
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          # release_template.md should be in dist/ if included in artifacts
          if [ -f "dist/release_template.md" ]; then
            sed "s/VERSION/${VERSION}/g" dist/release_template.md > release_notes.md
          else
            echo "Release notes template not found, using default."
            echo "Release $VERSION" > release_notes.md
          fi

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: dist/**/*
